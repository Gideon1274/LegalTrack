{% extends "base.html" %}
{% block title %}Case {{ case.tracking_id }}{% endblock %}

{% block content %}
<div class="card">
    <h2 class="page-title">Case {{ case.tracking_id }}</h2>
    <p class="page-subtitle">Status: <strong>{{ case.get_status_display }}</strong></p>

    <div class="row">
        <a class="btn btn-secondary btn-sm" href="{% url 'dashboard' %}">Back</a>
        {% if user.is_authenticated and user.role|slice:":8" == 'capitol_' %}
            <a class="btn btn-secondary btn-sm" href="{% url 'submissions' %}">Submissions</a>
        {% endif %}
        {% if can_edit %}
            <a class="btn btn-secondary btn-sm" href="{% url 'case_wizard' case.tracking_id 1 %}">Edit Submission</a>
        {% endif %}
    </div>
</div>

<div class="card card--flat">
    <div class="card__header">
        <strong>Case Information</strong>
    </div>
    <div class="card__body card__body--flush">
        <table class="table">
            <tbody>
                <tr><td style="width:22%" class="muted"><strong>Client</strong></td><td>{{ case.client_display_name }}</td></tr>
                <tr><td class="muted"><strong>Client Number</strong></td><td>{{ case.client_number|default:"—" }}</td></tr>
                <tr><td class="muted"><strong>Client Email</strong></td><td>{{ case.client_email|default:"—" }}</td></tr>
                <tr><td class="muted"><strong>Type of Case</strong></td><td>{{ case.get_case_type_display|default:"—" }}</td></tr>
                {% if case.numbering_number %}
                    <tr><td class="muted"><strong>Number</strong></td><td>{{ case.numbering_number }}</td></tr>
                {% endif %}
                <tr><td class="muted"><strong>Submitted by</strong></td><td>{{ case.submitted_by|default:"—" }}</td></tr>
                <tr><td class="muted"><strong>Created</strong></td><td>{{ case.created_at|date:"M d, Y H:i" }}</td></tr>
                {% if case.received_at %}
                    <tr><td class="muted"><strong>Received</strong></td><td>{{ case.received_at|date:"M d, Y H:i" }}{% if case.received_by %} (by {{ case.received_by.full_name }}){% endif %}</td></tr>
                {% endif %}
                {% if case.assigned_to %}
                    <tr><td class="muted"><strong>Assigned to</strong></td><td>{{ case.assigned_to.full_name }}{% if case.assigned_at %} ({{ case.assigned_at|date:"M d, Y H:i" }}){% endif %}</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

{% if case.return_reason and case.returned_at %}
    <div class="card">
        <h3 class="m-0" style="margin-bottom:8px;">Returned for Correction</h3>
        <p class="m-0"><strong>Reason:</strong> {{ case.return_reason }}</p>
        {% if case.returned_at %}
            <p class="muted" style="margin:8px 0 0 0;">Returned: {{ case.returned_at|date:"M d, Y H:i" }}</p>
        {% endif %}
    </div>
{% endif %}

<div class="card card--flat">
    <div class="card__header">
        <strong>Document Checklist</strong>
    </div>
    <div class="card__body card__body--flush">
        <table class="table">
            <thead>
                <tr>
                    <th>Document</th>
                    <th style="width:18%">Required</th>
                    <th style="width:18%">Uploaded</th>
                </tr>
            </thead>
            <tbody>
                {% for item in case.checklist %}
                    <tr>
                        <td>{{ item.doc_type }}</td>
                        <td>{{ item.required|yesno:"Yes,No" }}</td>
                        <td>{{ item.uploaded|yesno:"Yes,No" }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="3" class="muted"><em>No items</em></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if documents %}
    <div class="card card--flat">
        <div class="card__header">
            <strong>Uploaded Documents</strong>
        </div>
        <div class="card__body card__body--flush">
            <table class="table">
                <thead>
                    <tr>
                        <th>Document Type</th>
                        <th>File</th>
                        <th style="width:14%">View File</th>
                        <th style="width:22%">Uploaded</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in documents %}
                        <tr>
                            <td>{{ doc.doc_type }}</td>
                            <td class="muted">{{ doc.file.name|cut:"cases/" }}</td>
                            <td><a class="btn btn-secondary btn-sm" href="{{ doc.file.url }}" target="_blank" rel="noopener">View</a></td>
                            <td class="muted">{{ doc.uploaded_at|date:"M d, Y H:i" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endif %}

{% if not can_edit %}
    <p class="muted" style="margin:0 0 16px 0;"><em>This case can no longer be edited.</em></p>
{% endif %}

{% if can_receive %}
    <form method="post" action="{% url 'receive_case' case.tracking_id %}" class="card">
        {% csrf_token %}
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
            <div>
                <strong>Capitol Receiving</strong>
                <div class="muted">Mark this request as physically received.</div>
            </div>
            <button class="btn btn-primary" type="submit">Mark as Received</button>
        </div>
    </form>
{% endif %}

{% if can_return %}
    <form method="post" action="{% url 'return_case' case.tracking_id %}" class="card">
        {% csrf_token %}
        <label for="id_reason">Return Reason</label>
        <textarea id="id_reason" name="reason" rows="3" placeholder="State what needs correction..."></textarea>
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
            <button class="btn btn-danger" type="submit">Return to LGU</button>
        </div>
    </form>
{% endif %}

{% if can_assign %}
    <form method="post" action="{% url 'assign_case' case.tracking_id %}" class="card">
        {% csrf_token %}

        <label for="id_examiner">Assign to Examiner</label>
        <div class="row" style="align-items:end;">
            <div style="flex:1; min-width:260px;">
                <select id="id_examiner" name="examiner_id">
                    {% for examiner in examiners %}
                        <option value="{{ examiner.id }}">{{ examiner.full_name }} — {{ examiner.active_load }} active</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <button class="btn btn-primary" type="submit">Assign</button>
            </div>
        </div>
    </form>
{% endif %}

{% if can_remark %}
    <form method="post" action="{% url 'add_case_remark' case.tracking_id %}" class="card">
        {% csrf_token %}
        <strong>Internal Remarks</strong>
        <div class="muted" style="margin:6px 0 10px 0;">Visible to Capitol staff.</div>
        {{ remark_form.text.label_tag }}
        {{ remark_form.text }}
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
            <button class="btn btn-primary" type="submit">Add Remark</button>
        </div>
    </form>
{% endif %}

{% if remarks %}
    <div class="card card--flat">
        <div class="card__header">
            <strong>Remarks</strong>
        </div>
        <div class="card__body" style="padding:0;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Remark</th>
                        <th style="width:22%">By</th>
                        <th style="width:22%">When</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in remarks %}
                        <tr>
                            <td>{{ r.text|linebreaksbr }}</td>
                            <td class="muted">{{ r.created_by|default:"—" }}</td>
                            <td class="muted">{{ r.created_at|date:"M d, Y H:i" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endif %}

{# Case history moved to the bottom so action controls appear above it #}

{% if can_submit_for_approval %}
    <form method="post" action="{% url 'submit_for_approval' case.tracking_id %}" class="card">
        {% csrf_token %}
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
            <div>
                <strong>Examiner</strong>
                <div class="muted">Submit this case for approval.</div>
            </div>
            <button class="btn btn-primary" type="submit">Submit for Approval</button>
        </div>
    </form>
{% endif %}

{% if can_return_to_receiving %}
    <form method="post" action="{% url 'return_to_receiving' case.tracking_id %}" class="card">
        {% csrf_token %}
        <label for="id_examiner_reason">Return Reason</label>
        <textarea id="id_examiner_reason" name="reason" rows="3" placeholder="State what needs correction...">{{ case.return_reason|default:"" }}</textarea>
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
            <button class="btn btn-danger" type="submit">Return to Receiving</button>
        </div>
    </form>
{% endif %}

{% if can_approve %}
    <form method="post" action="{% url 'approve_case' case.tracking_id %}" class="card">
        {% csrf_token %}
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
            <div>
                <strong>Approver</strong>
                <div class="muted">Approve and send to numbering.</div>
            </div>
            <button class="btn btn-primary" type="submit">Approve</button>
        </div>
    </form>

    <form method="post" action="{% url 'return_for_correction' case.tracking_id %}" class="card">
        {% csrf_token %}
        <label for="id_approver_reason">Return Reason</label>
        <textarea id="id_approver_reason" name="reason" rows="3" placeholder="State what needs correction..."></textarea>
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
            <button class="btn btn-danger" type="submit">Return for Correction</button>
        </div>
    </form>
{% endif %}

{% if can_number %}
    <form method="post" action="{% url 'mark_numbered' case.tracking_id %}" class="card">
        {% csrf_token %}
        <label for="id_numbering_number">Number</label>
        <input id="id_numbering_number" name="numbering_number" value="{{ case.numbering_number|default:'' }}" placeholder="Enter number" />
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:12px;">
            <div>
                <strong>Numbering</strong>
                <div class="muted">Move this case to For Release.</div>
            </div>
            <button class="btn btn-primary" type="submit">Mark as Numbered</button>
        </div>
    </form>
{% endif %}

{% if can_release %}
    <form method="post" action="{% url 'release_case' case.tracking_id %}" class="card">
        {% csrf_token %}
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
            <div>
                <strong>Release</strong>
                <div class="muted">Mark this case as Released.</div>
            </div>
            <button class="btn btn-primary" type="submit">Release</button>
        </div>
    </form>
{% endif %}

{% if history %}
    <div class="card card--flat">
        <div class="card__header">
            <strong>Case History</strong>
        </div>
        <div class="card__body" style="padding:0;">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width:22%">When</th>
                        <th style="width:22%">Action</th>
                        <th style="width:22%">By</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in history %}
                        <tr>
                            <td class="muted">{{ h.created_at|date:"M d, Y H:i" }}</td>
                            <td>{{ h.get_action_display }}</td>
                            <td class="muted">{{ h.actor|default:"—" }}</td>
                            <td class="muted">{{ h.details_display|default:"—"|linebreaksbr }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endif %}
{% endblock %}