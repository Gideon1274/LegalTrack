{% extends "base.html" %}
{% block title %}Case {{ case.tracking_id }}{% endblock %}

{% block content %}
<div class="card">
    <h2 class="page-title">Case {{ case.tracking_id }}</h2>
    <p class="page-subtitle">Status: <strong>{{ case.get_status_display }}</strong></p>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn btn-secondary btn-sm" href="{% url 'dashboard' %}">Back</a>
        {% if can_edit %}
            <a class="btn btn-secondary btn-sm" href="{% url 'case_wizard' case.tracking_id 1 %}">Edit Submission</a>
        {% endif %}
    </div>
</div>

<div class="card card--flat">
    <div class="card__header">
        <strong>Case Information</strong>
    </div>
    <div class="card__body" style="padding:0;">
        <table class="table">
            <tbody>
                <tr><td style="width:22%" class="muted"><strong>Client</strong></td><td>{{ case.client_name }}</td></tr>
                <tr><td class="muted"><strong>Contact</strong></td><td>{{ case.client_contact|default:"—" }}</td></tr>
                <tr><td class="muted"><strong>Submitted by</strong></td><td>{{ case.submitted_by|default:"—" }}</td></tr>
                <tr><td class="muted"><strong>Created</strong></td><td>{{ case.created_at|date:"M d, Y H:i" }}</td></tr>
                {% if case.received_at %}
                    <tr><td class="muted"><strong>Received</strong></td><td>{{ case.received_at|date:"M d, Y H:i" }}{% if case.received_by %} (by {{ case.received_by.full_name }}){% endif %}</td></tr>
                {% endif %}
                {% if case.assigned_to %}
                    <tr><td class="muted"><strong>Assigned to</strong></td><td>{{ case.assigned_to.full_name }}{% if case.assigned_at %} ({{ case.assigned_at|date:"M d, Y H:i" }}){% endif %}</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

{% if case.received_at %}
    <p><strong>Received:</strong> {{ case.received_at|date:"M d, Y H:i" }}{% if case.received_by %} (by {{ case.received_by.full_name }}){% endif %}</p>
{% endif %}

{% if case.assigned_to %}
    <p><strong>Assigned to:</strong> {{ case.assigned_to.full_name }}{% if case.assigned_at %} ({{ case.assigned_at|date:"M d, Y H:i" }}){% endif %}</p>
{% endif %}

{% if case.status == 'returned' and case.return_reason %}
    <div class="card">
        <h3 style="margin:0 0 8px 0;">Returned for Correction</h3>
        <p style="margin:0;"><strong>Reason:</strong> {{ case.return_reason }}</p>
        {% if case.returned_at %}
            <p class="muted" style="margin:8px 0 0 0;">Returned: {{ case.returned_at|date:"M d, Y H:i" }}</p>
        {% endif %}
    </div>
{% endif %}

<div class="card card--flat">
    <div class="card__header">
        <strong>Document Checklist</strong>
    </div>
    <div class="card__body" style="padding:0;">
        <table class="table">
            <thead>
                <tr>
                    <th>Document</th>
                    <th style="width:18%">Required</th>
                    <th style="width:18%">Uploaded</th>
                </tr>
            </thead>
            <tbody>
                {% for item in case.checklist %}
                    <tr>
                        <td>{{ item.doc_type }}</td>
                        <td>{{ item.required|yesno:"Yes,No" }}</td>
                        <td>{{ item.uploaded|yesno:"Yes,No" }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="3" class="muted"><em>No items</em></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if documents %}
    <div class="card card--flat">
        <div class="card__header">
            <strong>Uploaded Documents</strong>
        </div>
        <div class="card__body" style="padding:0;">
            <table class="table">
                <thead>
                    <tr>
                        <th>Document Type</th>
                        <th>File</th>
                        <th style="width:22%">Uploaded</th>
                    </tr>
                </thead>
                <tbody>
                    {% for doc in documents %}
                        <tr>
                            <td>{{ doc.doc_type }}</td>
                            <td><a href="{{ doc.file.url }}" target="_blank" rel="noopener">View file</a></td>
                            <td class="muted">{{ doc.uploaded_at|date:"M d, Y H:i" }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endif %}

{% if not can_edit %}
    <p class="muted" style="margin:0 0 16px 0;"><em>This case can no longer be edited.</em></p>
{% endif %}

{% if can_receive %}
    <form method="post" action="{% url 'receive_case' case.tracking_id %}" class="card">
        {% csrf_token %}
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
            <div>
                <strong>Capitol Receiving</strong>
                <div class="muted">Mark this request as physically received.</div>
            </div>
            <button class="btn btn-primary" type="submit">Mark as Received</button>
        </div>
    </form>
{% endif %}

{% if can_return %}
    <form method="post" action="{% url 'return_case' case.tracking_id %}" class="card">
        {% csrf_token %}
        <label for="id_reason">Return Reason</label>
        <textarea id="id_reason" name="reason" rows="3" placeholder="State what needs correction..."></textarea>
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
            <button class="btn btn-danger" type="submit">Return to LGU</button>
        </div>
    </form>
{% endif %}

{% if can_assign %}
    <form method="post" action="{% url 'assign_case' case.tracking_id %}" class="card">
        {% csrf_token %}
        <label for="id_examiner">Assign to Examiner</label>
        <select id="id_examiner" name="examiner_id">
            {% for examiner in examiners %}
                <option value="{{ examiner.id }}">{{ examiner.full_name }} ({{ examiner.email }})</option>
            {% endfor %}
        </select>
        <div style="display:flex; justify-content:flex-end; margin-top:12px;">
            <button class="btn btn-primary" type="submit">Assign</button>
        </div>
    </form>
{% endif %}
{% endblock %}